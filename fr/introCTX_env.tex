%%%% vim: set tw=72 %%%
%%% File:      introCTX_env.mkiv
%%% Author:    Joaquín Ataz-López
%%% Created:   March 2020
%%% File edited with: Emacs + AucTeX - vim
%
% This file contains the preamble of the introduction to ConTeXt.  In
% the beginning I copied it from the source of the file about.pdf,
% included in the documentation on ConTeXt Standalone, and from there
% some things were changed in accordance with need.


\startenvironment introCTX_env

  %------------------------------------------------------------------------------
  % GENERAL

  \mainlanguage[fr]                                    % Main language = french

  \setupbodyfont[palatino,10.5pt]                    % The document's main (body) font

  \setupalign                                    % two instructions added by j.
    [hz,                                        % to eliminate most hyphenation
      lesshyphenated,                 % and get better interword spacing as well
      verytolerant,
      stretch]

\setuplanguage        % This avoids an extra space after full stops (periods)
    [en]                % which  is  no longer 'de rigueur' in printed material
    [spacing=packed]    % in English.

  \setupwhitespace[big] % Larger vertical space

  %------------------------------------------------------------------------------
  % PAGE LAYOUT, HEADERS, FOOTERS, PAGE NUMBERING
  \setuplayout
    [
      width=middle,
      height=middle,
      topspace=2.5cm,
      backspace=3cm,
      header=1cm,
      headerdistance=.5cm,
      footer=0.5cm
    ]
    
%------------------------------------------------------------------------------
  %------------------------------------------------------------------------------
  %------------------------------------------------------------------------------
  %------------------------------------------------------------------------------
% Trial Garulfo 
\startsetups [mylayout]

    \setuppapersize[A4]

    \def\nbdiv{11}
    \def\nbdiva{7}
    \def\nbdivb{2}

    \newdimen\marge   \marge   = 4mm
    \def\myfooterdistance{\marge}
    \def\myheaderdistance{\marge}

    \def\myheader{\dimexpr(((1\paperheight)/\nbdiv)/2-\marge)\relax}
    \def\myfooter{\dimexpr(((\nbdivb\paperheight)/\nbdiv)/2-\marge)\relax}

    \def\myleftmargin{\dimexpr(((1\paperwidth)/\nbdiv)/2-\marge)\relax}
    \def\myrightmargin{\dimexpr((\nbdivb\paperwidth)/\nbdiv)-\marge\relax}

    \setuplayout[
      width={\dimexpr((\nbdiva\paperwidth)/\nbdiv)-\marge\relax},
      backspace={\dimexpr(1\paperwidth/\nbdiv)+(\marge/2)\relax},
      % topspace + header + headerdistance = 24,75mm
      header=\myheader,
      headerdistance=\myheaderdistance,
      topspace={\dimexpr(1\paperheight/\nbdiv)+(\marge/2)-\myheader-\myheaderdistance\relax},
      % height - ( header + headerdistance + footer + footerdistance ) = 222.75mm
      footer=\myfooter,
      footerdistance=\myfooterdistance,
      height={\dimexpr((8\paperheight)/\nbdiv)-\marge+\myfooter+\myfooterdistance+\myheader+\myheaderdistance\relax},
      %
      topdistance=\marge,
      top=\myheader,
      bottomdistance=\marge,
      bottom=\myfooter,
      % edge and margin distance
      margindistance=\marge,
      edgedistance=\marge,
      %
      % left
      leftmargin=\myleftmargin,
      leftedge=\myleftmargin,
      % rigth
      rightmargin=\myrightmargin,
      rightedge=\myrightmargin]

    \newdimen\wDemoHN \wDemoHN=\dimexpr(1.0\textwidth)
    \newdimen\wDemoHW \wDemoHW=\dimexpr(1.0\textwidth+1.0\rightmargintotal)

    \newdimen\wComba \wComba=\dimexpr(0.5\textwidth+0.5\rightmargintotal-0.5\marge)
    \newdimen\wCombb \wCombb=\dimexpr(\textwidth/3+\rightmargintotal/3-2\marge/3)
    \newdimen\wDemoV \wDemoV=\dimexpr(0.5\textwidth+0.5\rightmargintotal-\marge)

  \stopsetups

  \setups{mylayout}
  
    %------------------------------------------------------------------------------
  %------------------------------------------------------------------------------
  %------------------------------------------------------------------------------
  %------------------------------------------------------------------------------
  %------------------------------------------------------------------------------

  
  \setuppagenumbering [location={header, right}]                 % Page numbers
  \setupuserpagenumber [number=2]
  \setupfootertexts[]                                   % Empty initial footers

  %------------------------------------------------------------------------------

  \usepath[{00_FrontMatter,01_BodyMatter,02_Appendices}]

  \setupexternalfigures [directory={./img,img}, location=global]      % Image directory

  %------------------------------------------------------------------------------

  \setupitemize [indenting=none]        % First line of paragraphs not indented

  \setupcaptions [headstyle=\bfx, style=\tfx] % Style of table and image titles

  %------------------------------------------------------------------------------

  \definecolor [maincolor] [.6(orange)]                          % Title colour

  \definecolor [purple] [.5(darkblue)]                           % Cover colour

  \setuptype [color=darkmagenta]           % Writing commands and code snippets

  \setuptyping
    [color=darkmagenta,style={\switchtobodyfont[small,tt]}]

  \setuplabeltext                                                      % Labels
    [fr]
    [
      chapter=Chapitre~,
      appendix=Annexe~,
      part=Partie~
    ]

  \setupnotation                                                    % Footnotes
    [footnote]
    [way=bypage, numberconversion=n, after={\blank[small]}]


  %------------------------------------------------------------------------------
  % PARTS, CHAPTERS, SECTIONS, ETC.

  % This snippet defines a footer with page numbers. A name is assigned
  % to it, and then, when section commands are configured, this name is
  % assigned to the first page of part and chapter.
  \definetext[ChapterFirstPage]
             [footer]
             [pagenumber]

  \setuphead
    [part]
    [
      placehead=yes,
      alternative=middle,
      conversion=I,
      style={\switchtobodyfont[36pt]\bf},
      color=purple,
      before={\ \godown[4cm]},
      header=high,
      footer=ChapterFirstPage,
    ]

  \setuphead
    [title, chapter]
    [
      style={\switchtobodyfont[30pt]\bf},
      align=flushright,
      before={\blank[5*big, force]},
      after={\blank[2*big]},
      color=maincolor,
      sectionsegments=2:2,
      commandbefore={\blank[small]},
      header=high,
      footer=ChapterFirstPage,
    ]

  \setuphead
    [section, subject]
    [
      style={\bfc},
      before={\blank[2*big]},
      after=\blank,
      color=maincolor,
      sectionsegments=2:3,
    ]

  \setuphead
    [subsection, subsubject]
    [
      style={\bfb},
      before=\blank,
      after=\blank,
      color=maincolor,
      sectionsegments=2:4,
    ]

  \define[1]\PlacePoint{#1.}

  \setuphead
    [subsubsection,subsubsubject]
    [
      sectionsegments=5:5,
      conversion=A,
      style=\bfa,
      color=black,
      numbercommand=,
    ]

  \setuphead
    [subsubsection][numbercommand=\PlacePoint]

 % \setuptyping[bodyfont=10pt]

  %==============================================================================
  % STRUCTURES DEFINED BY ME

  %------------------------------------------------------------------------------

  \definedescription
    [description]
    [
      alternative=hanging,
      width=fit,
      distance=0.3cm,
      headstyle=\bf
    ]

  %------------------------------------------------------------------------------

  \definedescription
    [semitable]
    [
      alternative=left,
      width=fit,
      distance=1cm,
      headcolor=darkmagenta,
      headstyle=\tt,
    ]

  %==============================================================================
  % ENVIRONMENTS DEFINED BY ME

  % DoubleExample: For two column examples. It gave some errors when
  % defining it with \definestartstop (due to my lack of knowledge) and
  % in the end what I did was to define a TeX style command for opening
  % it, and another command for closing it.


  \def\startDoubleExample{%
    \startframedtext
      [frame=off]
      \switchtobodyfont[small]
      \setuptyping[style=tt]
      \startcolumns
        [
          n=2,
          tolerance=verytolerant,
          distance=0.5cm,
          separator=rule,
          rulecolor=darkmagenta
        ]
  }

  \def\stopDoubleExample{\stopcolumns\stopframedtext}

  %------------------------------------------------------------------------------

  % Small print
  \definestartstop[SmallPrint]
                  [
                    before={\startnarrower\switchtobodyfont[small,ss]},
                    after={\stopnarrower},
                  ]

  %------------------------------------------------------------------------------
  % Commands and abbreviations

  % Assumption: Print the assumption icon in the margin
  \define\Conjecture{%
    \inouter[line=1]{\externalfigure[conjecture.pdf][width=1cm]}}

  % Doubt: Print the doubt icon in the margin
  \define\Doubt{%
    \inouter[line=1]{\externalfigure[doubt.pdf][width=1cm]}}

  % example: Show in red and in small print the result of compiling an
  % earlier code snippet.
  \define[1]\example{\color[red]{\tfx#1}}

  % ConTeXt Standalone
  \def\suite-{\quotation{\ConTeXt\ Standalone}}

  % cmd: to be used in place of tex when, in the source file, there is a
  % line break in an argument.
  \define[1]\cmd{
    {\en\tt\color[darkmagenta]{\backslash #1}}}

  % PalClave:  tt and guillemets (angle quotes)
  % \define[1]\PalClave{«{\tt #1}»}

  % MyKey: tt and double inverted commas
  \define[1]\MyKey{\quotation{\tt #1}}

  % Partial chapter table of contents:
  \def\Separate#1{#1;}
  \def\TocChap{
    \startnarrower\switchtobodyfont[small, sl]
      {\bf Table of Contents:}
      \setuplist
        [section,subsection,subsubsection]
        [pagenumber=no, textcommand=\Separate]
      \setuplist[section][style=bold]
      \placecontent[alternative=d]
    \stopnarrower
  }

  % Index
  \defineregister[macro]
  \define[1]\PlaceMacro{\macro[#1]{\backslash #1}}


  %======================================================
  % ADDED BY GARULFO

  \setuplinenumbering[style=\tt\tfxx,align=left]

\defineframedtext
  [framedcode]
  [strut=yes,
   offset=2mm,
   width=local,
   align=right]

\definetyping
  [code]
  [numbering=line,
    option=tex,
    bodyfont=small,
    before={\startframedcode},
    after={\stopframedcode}]

  \definetyping
  [terminal]
  [numbering=line,
    option=none,
    bodyfont=small,
    before={\startframedcode},
    after={\stopframedcode}]

  %------------------------------------------------------------------------------
  % INTERACTIVITY
  \setupinteraction
    [
      state=start,
      color=darkblue,
      contrastcolor=darkblue,
      style=,
    ]

  \setupurl [color=blue, style=\tt]

  \useurl
    [pragma]
    [http://www.pragma-ade.com/]

  \useurl
    [wiki]
    [https://www.contextgarden.net/]
    [] [\ConTeXt\ Garden wiki]

  \useurl
    [wikisymbols]
    [https://wiki.contextgarden.net/Symbols/utf8]

  \useurl
    [ntg-context]
    [https://mailman.ntg.nl/pipermail/ntg-context]
    [] [ntg-context]

  \useurl
    [excursion]
    [http://www.pragma-ade.com/general/manuals/ma-cb-en.pdf]
    [] [\quotation{\ConTeXt\ Mark~IV, an Excursion}]

  \useurl
    [manualref2001]
    [http://www.pragma-ade.com/general/manuals/cont-enp.pdf]
    [] [\quotation{\ConTeXt\ Reference Manual 2001}]

  \useurl
    [manualref2013]
    [http://pmrb.free.fr/contextref.pdf]
    [] [\quotation{\ConTeXt\ Reference Manual 2013}]

  \useurl
    [commandes]
    [http://www.pragma-ade.com/general/qrcs/setup-en.pdf]
    [] [\quotation{\ConTeXt\ Commands}]

  %=============================> ADDED BY GARULFO - START <=====================


  \placebookmarks[chapter, section, subsection, subsubsection]


  %------------------------------------------------------------------------------

  \startsectionblockenvironment[bodypart]
    \setupheadertexts                                                      % middle
      [{\tfx\getmarking[chapter]}]
    \setupheadertexts                                                       % sides
      [{\tfx\labeltext{chapter}\getmarking[chapternumber]}]
      [{\tfx\pagenumber}]
  \stopsectionblockenvironment

  %------------------------------------------------------------------------------

  \startsectionblockenvironment[frontpart]
    \setupheadertexts
      [{\tfx\getmarking[chapter]}]
      [{\tfx\pagenumber}]
    \setuphead
      [chapter]
      [incrementnumber=list,
        after={\strut\blank[3*big]},]
  \stopsectionblockenvironment

  %------------------------------------------------------------------------------

  \startsectionblockenvironment[appendix]
    \setuplabeltext
      [en]
      [chapter={Appendix~}]
    \setuphead[part][number=no]                       % No numbering for part here
    \setupheadertexts                                                      % middle
      [{\tfx\getmarking[chapter]}]
    \setupheadertexts                                                       % sides
      [{\tfx\labeltext{chapter}\getmarking[chapternumber]}]
      [{\tfx\pagenumber}]
  \stopsectionblockenvironment

  %------------------------------------------------------------------------------

  \definestructureresetset
    [mywaytoreset]
    [0,0]                          % do not reset when change of part or chapter
    [1]                                                             % else reset


  \setuphead
    [chapter]
    [sectionresetset=mywaytoreset]

  %------------------------------------------------------------------------------
  % pour la table des matières
  \setuplist
    [part]
    [
      before={\blank[2*big]},
      after={\blank[big]},
      style=\bfa,
      aligntitle=yes,
    ]

  \setuplist
    [chapter]
    [
      before=\blank,
      style=\bf,
      margin=.5cm,
      aligntitle=yes
    ]

  \setuplist
    [section]
    [
      aligntitle=yes,
      style=\tfx,
      margin=1.5cm
    ]

  \definecombinedlist                     % Let us define our list (called a Toc)
    [Toc]
    [part, chapter, section]
    [level=subsection, alternative=c,criterium=text]

  \setupheadtext [fr] [Toc=Table des matières]

  %=============================> ADDED BY GARULFO - END   <=====================
  
  
  %-------------------------------------------------------------------------------
  % #08 - MISE EN PAGE DES DEMONSTRATONS
  %-------------------------------------------------------------------------------

  \newdimen\marge   \marge   = 4mm

  \newdimen\wDemoHN \wDemoHN=\dimexpr(1.0\textwidth)
  \newdimen\wDemoHW \wDemoHW=\dimexpr(1.0\textwidth+1.0\rightmargintotal)

  \newdimen\wComba \wComba=\dimexpr(0.5\textwidth+0.5\rightmargintotal-0.5\marge)
  \newdimen\wCombb \wCombb=\dimexpr(\textwidth/3+\rightmargintotal/3-2\marge/3)
  \newdimen\wDemoV \wDemoV=\dimexpr(0.5\textwidth+0.5\rightmargintotal-\marge)
  
  \setupcolor[hex]
  \definecolor[hex-orange] [h=ED7D31]
  \definecolor[hex-vert]   [h=70AD47]
  \definecolor[hex-orangel][h=FEE8E1]
  \definecolor[hex-vertl]  [h=E2EDDB]

  % si besoin de mettre en forme par TeX des commentaires dans les codes sources
  % il faut les encadrer par [[ et ]] comme indiqué dans typebuffer, option escape

  \definestartstop[comment][style={\rm}]

  % startDemoHN ==> horizontal split, normal width
  % startDemoHW ==> horizontal split, wide
  % startDemoVN ==> vertical split, normal width
  % startDemoVW ==> vertical split, wide
  % startDemoI  ==> for input file
  % startDemoC  ==> for shell command

  \startluacode
    userdata = userdata or {}

    function userdata.Demolua(buffer,lettre)
    if lettre=="HN" then
    Tlarg="{\\dimexpr\\textwidth-\\marge\\relax}"
    elseif lettre=="HW" then
    Tlarg="{\\dimexpr\\textwidth+\\rightmargintotal-\\marge\\relax}"
    elseif lettre=="VN" then
    Tlarg="{\\dimexpr0.5\\textwidth-1.5\\marge\\relax}"
    elseif lettre=="VW" then
    Tlarg="{\\dimexpr0.5\\textwidth+0.5\\rightmargintotal-1.5\\marge\\relax}"
    end

    buffers.assign("tempo",buffers.getcontent(buffer))
    buffers.assign(buffer,"\\startTEXpage %\n")
    buffers.append(buffer,"\\project ma-cb %\n")
    buffers.append(buffer,"\\setupbodyfont[palatino,9pt] %\n")
    buffers.append(buffer,"\\framed[align=normal,\n width=" .. Tlarg .. ",\n offset=0pt,\n frame=off,strut=no]{%debutZ\n")
      buffers.append(buffer,buffers.getcontent("tempo"))
      buffers.append(buffer,"\n%finZ \n}\n")
    buffers.append(buffer,"\\stopTEXpage\n")
    end
  \stopluacode

  %-------------------------------------------------------------------------------

  \def\startDemoHN{\dostartbuffer[DemoTbuff][startDemoHN][stopDemoHN]}

  \def\stopDemoHN{\ctxlua{userdata.Demolua('DemoTbuff',"HN")}%
    \startplacetable[location={none,force}]
      \bTABLE
      \setupTABLE[frame=off,offset=2pt,spaceinbetween=\the\marge]
      \setupTABLE[column][1][width=\wDemoHN,align=flushleft] %
      \bTR
      \bTD[topframe=on,rulethickness=3pt,framecolor=hex-orange,background=color,backgroundcolor=gray]
      \typebuffer[DemoTbuff][bodyfont=small,option=tex,range={debutZ,finZ},escape={[[,]]}]
      \eTD
      \eTR
      \bTR
      \bTD[bottomframe=on,rulethickness=3pt,framecolor=hex-vert,background=color,backgroundcolor=gray]
      \strut\typesetbuffer[DemoTbuff][page=1,frame=off]
      \eTD
      \eTR
      \eTABLE
    \stopplacetable}

  %-------------------------------------------------------------------------------

  \def\startDemoHW{\dostartbuffer[DemoTbuff][startDemoHW][stopDemoHW]}

  \def\stopDemoHW{\ctxlua{userdata.Demolua('DemoTbuff',"HW")}%
    \startplacetable[location={none,force}]
      \bTABLE
      \setupTABLE[frame=off,offset=2pt,spaceinbetween=\the\marge]
      \setupTABLE[column][1][width=\wDemoHW,align=flushleft] %
      \bTR
      \bTD[topframe=on,rulethickness=3pt,framecolor=hex-orange,background=color,backgroundcolor=gray]
      \typebuffer[DemoTbuff][bodyfont=small,option=tex,range={debutZ,finZ},escape={[[,]]}]
      \eTD
      \eTR
      \bTR
      \bTD[bottomframe=on,rulethickness=3pt,framecolor=hex-vert,background=color,backgroundcolor=gray]
      \strut\typesetbuffer[DemoTbuff][page=1,frame=off]
      \eTD
      \eTR
      \eTABLE
    \stopplacetable}

  %-------------------------------------------------------------------------------

  \def\startDemoVW{\dostartbuffer[DemoTbuff][startDemoVW][stopDemoVW]}

  \def\stopDemoVW{\ctxlua{userdata.Demolua('DemoTbuff',"VW")}%
    \startplacetable[location={none,force}]
      \bTABLE
      \setupTABLE[frame=off,offset=2pt]
      \setupTABLE[column][1][width={\dimexpr0.5\wDemoHW-0.5\marge\relax},align=flushleft]
      \setupTABLE[column][2][width=\marge,align=flushleft]
      \setupTABLE[column][3][width={\dimexpr0.5\wDemoHW-0.5\marge\relax},align=flushleft]
      \bTR
      \bTD[leftframe=on,rulethickness=3pt,framecolor=hex-orange,background=color,backgroundcolor=gray]
      \typebuffer[DemoTbuff][bodyfont=small,option=tex,range={debutZ,finZ},escape={[[,]]}]
      \eTD
      \bTD    \eTD
      \bTD[rightframe=on,rulethickness=3pt,framecolor=hex-vert,background=color,backgroundcolor=gray]
      \strut\typesetbuffer[DemoTbuff][page=1,frame=off]
      \eTD
      \eTR
      \eTABLE
    \stopplacetable}

  %-------------------------------------------------------------------------------

  \def\startDemoVN{\dostartbuffer[DemoTbuff][startDemoVN][stopDemoVN]}

  \def\stopDemoVN{\ctxlua{userdata.Demolua('DemoTbuff',"VN")}%
    \startplacetable[location={none,force}]
      \bTABLE
      \setupTABLE[frame=off,offset=2pt,strut=no]
      \setupTABLE[column][1][width={\dimexpr0.5\wDemoHN-0.5\marge\relax},align=flushleft]
      \setupTABLE[column][2][width=\marge,align=flushleft]
      \setupTABLE[column][3][width={\dimexpr0.5\wDemoHN-0.5\marge\relax},align=flushleft]
      \bTR
      \bTD[leftframe=on,rulethickness=3pt,framecolor=hex-orange,background=color,backgroundcolor=gray,strut=no]
      \typebuffer[DemoTbuff][bodyfont=small,option=tex,range={debutZ,finZ},escape={[[,]]}]
      \eTD
      \bTD    \eTD
      \bTD[rightframe=on,rulethickness=3pt,framecolor=hex-vert,background=color,backgroundcolor=gray,strut=no]
      \strut\typesetbuffer[DemoTbuff][page=1,frame=off,strut=no]
      \eTD
      \eTR
      \eTABLE
    \stopplacetable}

  %-------------------------------------------------------------------------------

  \def\startDemoI{\dostartbuffer[DemoTbuffI][startDemoI][stopDemoI]}

  \def\stopDemoI{\ctxlua{userdata.Demolua("DemoTbuffI","HN")}%
%    \startplacetable[location={none,force}] 
      \bTABLE
      \setupTABLE[frame=off,offset=2pt,spaceinbetween=\the\marge]
      \setupTABLE[column][1][width=\wDemoHN,align=flushleft]
      \bTR
      \bTD[leftframe=on,rulethickness=3pt,framecolor=darkblue,background=color,backgroundcolor=gray]
      \typebuffer[DemoTbuffI][bodyfont=small,option=tex,range={debutZ,finZ},escape={[[,]]}]
      \eTD
      \eTABLE}
%    \stopplacetable}

  %-------------------------------------------------------------------------------

  \def\startDemoC{\dostartbuffer[Demobuff][startDemoC][stopDemoC]}

  \def\stopDemoC{\ctxlua{userdata.Demolua("Demobuff","HN")}%
    \startplacetable[location={none,force}]
      \bTABLE
      \setupTABLE[frame=off,offset=2pt,spaceinbetween=\the\marge]
      \setupTABLE[column][1][width=\wDemoHN,align=flushleft]
      \bTR
      \bTD[leftframe=on,rulethickness=3pt,loffset=1mm,framecolor=darkred,background=color,backgroundcolor=gray]
      \typebuffer[Demobuff][numbering=fine,bodyfont=10pt,option=,range={debutZ,finZ}] %,escape={[[,]]}]
  \eTD
  \eTABLE
\stopplacetable}


\definefloat[DemC][DemCs][]


%===================================================================================================
% 10 - Notes de bas de page ou notes marginales
%===================================================================================================
\setupnote[footnote][location=none]

\setupnotation[footnote][
    align=flushleft,
    location=serried,
    width=broad,
]
\setuptexttexts[margin][]
    [{\framed[%
    align={right,bottom},
    frame=off,
    height=\textheight,
    width=\rightmarginwidth
    ]{\placenotes[footnote]}}]



% \define\PlaceFootnote
%   {\inrightmargin{\vtop{\placelocalnotes[footnote][before=,after=]}}}

% \setupnote
%   [footnote]
%   [location=text,
%    bodyfont=,
%    next=\PlaceFootnote]

% \setupnotation
%   [footnote]
%   [alternative=serried]

% \setuplayout
%   [width=12cm,
%    rightmargindistance=0.5cm,
%    rightmargin=5cm]


\stopenvironment

%%% Local Variables:
%%% mode: ConTeXt
%%% mode: auto-fill
%%% TeX-master: "introCTX.mkiv"
%%% coding: utf-8-unix
%%% End:
